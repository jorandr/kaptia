name: üîÑ Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      backup_file:
        description: 'Backup file name (e.g., backup_20260210_120000.tar.gz) or "latest" for most recent'
        required: true
        default: 'latest'
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DEPLOY_DIR: /opt/kaptia
  BACKUP_DIR: /backups/kaptia

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: üìù Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ‚èÆÔ∏è Perform rollback
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            # Colores
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            BLUE='\033[0;34m'
            NC='\033[0m'
            
            echo -e "${YELLOW}‚ö†Ô∏è  Starting rollback process...${NC}"
            
            cd ${{ env.BACKUP_DIR }}
            
            # Determinar archivo de backup
            if [ "${{ github.event.inputs.backup_file }}" = "latest" ]; then
              BACKUP_FILE=$(ls -t backup_*.tar.gz 2>/dev/null | head -1)
              if [ -z "$BACKUP_FILE" ]; then
                echo -e "${RED}‚úó No backup files found${NC}"
                exit 1
              fi
            else
              BACKUP_FILE="${{ github.event.inputs.backup_file }}"
              if [ ! -f "$BACKUP_FILE" ]; then
                echo -e "${RED}‚úó Backup file not found: $BACKUP_FILE${NC}"
                exit 1
              fi
            fi
            
            echo -e "${BLUE}Using backup: $BACKUP_FILE${NC}"
            
            # Detener contenedores actuales
            echo -e "${BLUE}Stopping current containers...${NC}"
            cd ${{ env.DEPLOY_DIR }}
            sudo docker compose down || true
            
            # Crear backup del estado actual antes de rollback
            echo -e "${BLUE}Creating backup of current state...${NC}"
            CURRENT_BACKUP="backup_before_rollback_$(date +%Y%m%d_%H%M%S).tar.gz"
            tar -czf "${{ env.BACKUP_DIR }}/$CURRENT_BACKUP" --exclude='*.log' .
            
            # Restaurar backup
            echo -e "${BLUE}Restoring backup...${NC}"
            cd ${{ env.DEPLOY_DIR }}
            sudo rm -rf *
            sudo tar -xzf "${{ env.BACKUP_DIR }}/$BACKUP_FILE" -C ${{ env.DEPLOY_DIR }}
            
            # Reiniciar servicios
            echo -e "${BLUE}Starting services...${NC}"
            sudo docker compose up -d
            
            # Verificar estado
            sleep 10
            sudo docker compose ps
            
            echo -e "${GREEN}‚úì Rollback completed successfully!${NC}"
            echo -e "${YELLOW}‚ÑπÔ∏è  Current state backed up as: $CURRENT_BACKUP${NC}"
          EOF
      
      - name: üè• Health check
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}
            
            RUNNING=$(sudo docker compose ps --filter "status=running" --format json | jq -s 'length')
            TOTAL=$(sudo docker compose ps --format json | jq -s 'length')
            
            echo "Containers running: $RUNNING/$TOTAL"
            
            if [ "$RUNNING" -eq "$TOTAL" ]; then
              echo "‚úì All containers are healthy after rollback"
              exit 0
            else
              echo "‚ö† Some containers are not running after rollback"
              sudo docker compose ps
              exit 1
            fi
          EOF
      
      - name: üìä Rollback summary
        if: always()
        run: |
          echo "## ‚èÆÔ∏è Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup file:** ${{ github.event.inputs.backup_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
