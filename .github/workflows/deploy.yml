name: üöÄ Deploy to Production

on:
  workflow_dispatch:
    inputs:
      cliente:
        description: 'Cliente a deployar'
        required: true
        type: choice
        options:
          - PRIMEHOUSING

env:
  DEPLOY_DIR: /opt/kaptia
  BACKUP_DIR: /backups/kaptia

jobs:
  deploy:
    name: Deploy Kaptia
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets[format('{0}_SSH_PRIVATE_KEY', github.event.inputs.cliente)] }}
      
      - name: üìù Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts
      
      - name: üß™ Test SSH connection
        run: |
          SSH_USER="${{ secrets[format('{0}_SSH_USER', github.event.inputs.cliente)] }}"
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          ssh ${SSH_USER}@${SERVER_HOST} "echo '‚úì SSH connection successful'"
      
      - name: üì¶ Prepare deployment package
        run: |
          cd app
          tar -czf ../kaptia-app.tar.gz \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='node_modules' \
            .
      
      - name: üöÄ Upload to server
        run: |
          SSH_USER="${{ secrets[format('{0}_SSH_USER', github.event.inputs.cliente)] }}"
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          scp kaptia-app.tar.gz ${SSH_USER}@${SERVER_HOST}:/tmp/
      
      - name: üìã Create .env file on server
        env:
          PROJECT_NAME: ${{ secrets[format('{0}_PROJECT_NAME', github.event.inputs.cliente)] }}
          DOMAIN: ${{ secrets[format('{0}_DOMAIN', github.event.inputs.cliente)] }}
          POSTGRES_PASSWORD: ${{ secrets[format('{0}_POSTGRES_PASSWORD', github.event.inputs.cliente)] }}
          CHATWOOT_SECRET: ${{ secrets[format('{0}_CHATWOOT_SECRET_KEY_BASE', github.event.inputs.cliente)] }}
          CHATWOOT_DOMAIN: ${{ secrets[format('{0}_CHATWOOT_DOMAIN', github.event.inputs.cliente)] }}
          WAHA_API_KEY: ${{ secrets[format('{0}_WAHA_API_KEY_PLAIN', github.event.inputs.cliente)] }}
        run: |
          SSH_USER="${{ secrets[format('{0}_SSH_USER', github.event.inputs.cliente)] }}"
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          
          ssh ${SSH_USER}@${SERVER_HOST} << 'EOF'
            cat > /tmp/kaptia.env << 'ENVFILE'
          PROJECT_NAME=${{ env.PROJECT_NAME }}
          DOMAIN=${{ env.DOMAIN }}
          POSTGRES_USER=admin
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB=kaptia_db
          CHATWOOT_DOMAIN=${{ env.CHATWOOT_DOMAIN }}
          CHATWOOT_SECRET_KEY_BASE=${{ env.CHATWOOT_SECRET }}
          CHATWOOT_DATABASE=chatwoot_production
          NOCODB_DOMAIN=nocodb.${{ env.DOMAIN }}
          N8N_DOMAIN=${{ env.DOMAIN }}
          N8N_PORT=5678
          WAHA_DOMAIN=waha.${{ env.DOMAIN }}
          WAHA_API_KEY_PLAIN=${{ env.WAHA_API_KEY }}
          WAHA_API_KEY_HASH=sha512:$(echo -n "${{ env.WAHA_API_KEY }}" | sha512sum | cut -d' ' -f1)
          DEFAULT_LOCALE=es
          LETSENCRYPT_EMAIL=admin@${{ env.DOMAIN }}
          ENVFILE
          EOF
      
      - name: üîÑ Deploy application
        run: |
          SSH_USER="${{ secrets[format('{0}_SSH_USER', github.event.inputs.cliente)] }}"
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          
          ssh ${SSH_USER}@${SERVER_HOST} << 'EOF'
            set -e
            
            # Colores
            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            NC='\033[0m'
            
            echo -e "${BLUE}Starting deployment...${NC}"
            
            # Crear backup si existe instalaci√≥n previa
            if [ -d "${{ env.DEPLOY_DIR }}" ] && [ -f "${{ env.DEPLOY_DIR }}/docker-compose.yml" ]; then
              echo -e "${BLUE}Creating backup...${NC}"
              mkdir -p ${{ env.BACKUP_DIR }}
              BACKUP_FILE="${{ env.BACKUP_DIR }}/backup_$(date +%Y%m%d_%H%M%S).tar.gz"
              cd ${{ env.DEPLOY_DIR }}
              sudo docker compose down || true
              tar -czf "$BACKUP_FILE" --exclude='*.log' --exclude='node_modules' .
              echo -e "${GREEN}‚úì Backup created: $BACKUP_FILE${NC}"
            fi
            
            # Preparar directorio
            echo -e "${BLUE}Preparing deployment directory...${NC}"
            sudo mkdir -p ${{ env.DEPLOY_DIR }}
            cd ${{ env.DEPLOY_DIR }}
            
            # Extraer aplicaci√≥n
            echo -e "${BLUE}Extracting application files...${NC}"
            sudo tar -xzf /tmp/kaptia-app.tar.gz -C ${{ env.DEPLOY_DIR }}
            
            # Mover .env
            sudo mv /tmp/kaptia.env ${{ env.DEPLOY_DIR }}/.env
            sudo chmod 600 ${{ env.DEPLOY_DIR }}/.env
            
            # Pull im√°genes
            echo -e "${BLUE}Pulling Docker images...${NC}"
            sudo docker compose pull
            
            # Desplegar
            echo -e "${BLUE}Deploying application...${NC}"
            sudo docker compose up -d --remove-orphans
            
            # Verificar estado
            echo -e "${BLUE}Checking container status...${NC}"
            sleep 10
            sudo docker compose ps
            
            # Limpiar
            rm -f /tmp/kaptia-app.tar.gz
            
            echo -e "${GREEN}‚úì Deployment completed successfully!${NC}"
          EOF
      
      - name: üè• Health check
        run: |
          SSH_USER="${{ secrets[format('{0}_SSH_USER', github.event.inputs.cliente)] }}"
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          
          ssh ${SSH_USER}@${SERVER_HOST} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}
            
            # Verificar contenedores en ejecuci√≥n
            RUNNING=$(sudo docker compose ps --filter "status=running" --format json | jq -s 'length')
            TOTAL=$(sudo docker compose ps --format json | jq -s 'length')
            
            echo "Containers running: $RUNNING/$TOTAL"
            
            if [ "$RUNNING" -eq "$TOTAL" ]; then
              echo "‚úì All containers are healthy"
              exit 0
            else
              echo "‚ö† Some containers are not running"
              sudo docker compose ps
              exit 1
            fi
          EOF
      
      - name: üìä Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Cliente:** ${{ github.event.inputs.cliente }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
      
      - name: üí¨ Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs for more details."
