name: üöÄ Deploy to Production

on:
  workflow_dispatch:
    inputs:
      cliente:
        description: 'Cliente a deployar'
        required: true
        type: choice
        options:
          - PRIMEHOUSING
          - CMGESTION

env:
  # Directorio base se construye din√°micamente por cliente
  DEPLOY_BASE: /opt
  BACKUP_BASE: /backups

jobs:
  deploy:
    name: Deploy Kaptia
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SHARED_SSH_PRIVATE_KEY }}
      
      - name: üìù Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SHARED_SERVER_HOST }}" >> ~/.ssh/known_hosts
      
      - name: üß™ Test SSH connection
        run: |
          ssh ${{ secrets.SHARED_SSH_USER }}@${{ secrets.SHARED_SERVER_HOST }} "echo '‚úì SSH connection successful'"
      
      - name: üì¶ Prepare deployment package
        run: |
          cd app
          tar -czf ../kaptia-app.tar.gz \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='node_modules' \
            .
      
      - name: üöÄ Upload to server
        run: |
          CLIENTE_LOWER=$(echo "${{ github.event.inputs.cliente }}" | tr '[:upper:]' '[:lower:]')
          
          # Crear directorio espec√≠fico del cliente
          ssh ${{ secrets.SHARED_SSH_USER }}@${{ secrets.SHARED_SERVER_HOST }} "sudo mkdir -p ${{ env.DEPLOY_BASE }}/kaptia-${CLIENTE_LOWER}"
          
          scp kaptia-app.tar.gz ${{ secrets.SHARED_SSH_USER }}@${{ secrets.SHARED_SERVER_HOST }}:/tmp/
      
      - name: üìã Create .env file on server
        env:
          PROJECT_NAME: ${{ secrets[format('{0}_PROJECT_NAME', github.event.inputs.cliente)] }}
          DOMAIN: ${{ secrets[format('{0}_DOMAIN', github.event.inputs.cliente)] }}
          POSTGRES_PASSWORD: ${{ secrets[format('{0}_POSTGRES_PASSWORD', github.event.inputs.cliente)] }}
          CHATWOOT_SECRET: ${{ secrets[format('{0}_CHATWOOT_SECRET_KEY_BASE', github.event.inputs.cliente)] }}
        run: |
          CLIENTE_LOWER=$(echo "${{ github.event.inputs.cliente }}" | tr '[:upper:]' '[:lower:]')
          
          # Generar valores derivados
          WAHA_API_KEY=$(openssl rand -hex 32)
          WAHA_DASHBOARD_PASSWORD=$(openssl rand -base64 16)
          WAHA_SWAGGER_PASSWORD=$(openssl rand -base64 16)
          
          ssh ${{ secrets.SHARED_SSH_USER }}@${{ secrets.SHARED_SERVER_HOST }} << EOF
            cat > /tmp/kaptia.env << 'ENVFILE'
          PROJECT_NAME=${{ env.PROJECT_NAME }}
          DOMAIN=${{ env.DOMAIN }}
          
          POSTGRES_USER=admin
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB=kaptia_db
          
          CHATWOOT_DOMAIN=crm.${{ env.DOMAIN }}
          CHATWOOT_SECRET_KEY_BASE=${{ env.CHATWOOT_SECRET }}
          CHATWOOT_DATABASE=kaptia_db
          
          NOCODB_DOMAIN=db.${{ env.DOMAIN }}
          
          N8N_DOMAIN=n8n.${{ env.DOMAIN }}
          N8N_PORT=5678
          
          WAHA_DOMAIN=waha.${{ env.DOMAIN }}
          WAHA_API_KEY_PLAIN=${WAHA_API_KEY}
          WAHA_API_KEY_HASH=sha512:\$(echo -n "${WAHA_API_KEY}" | sha512sum | cut -d' ' -f1)
          WAHA_DASHBOARD_USERNAME=admin
          WAHA_DASHBOARD_PASSWORD=${WAHA_DASHBOARD_PASSWORD}
          WAHA_SWAGGER_USERNAME=admin
          WAHA_SWAGGER_PASSWORD=${WAHA_SWAGGER_PASSWORD}
          
          TRAEFIK_NETWORK=nieto-network
          LETSENCRYPT_EMAIL=${{ secrets.SHARED_LETSENCRYPT_EMAIL }}
          
          TZ=America/Bogota
          DEFAULT_LOCALE=es
          ENVFILE
          EOF
      
      - name: üîÑ Deploy application
        run: |
          CLIENTE_LOWER=$(echo "${{ github.event.inputs.cliente }}" | tr '[:upper:]' '[:lower:]')
          DEPLOY_DIR="${{ env.DEPLOY_BASE }}/kaptia-${CLIENTE_LOWER}"
          BACKUP_DIR="${{ env.BACKUP_BASE }}/kaptia-${CLIENTE_LOWER}"
          
          ssh ${{ secrets.SHARED_SSH_USER }}@${{ secrets.SHARED_SERVER_HOST }} << EOF
            set -e
            
            # Colores
            GREEN='\033[0;32m'
            BLUE='\033[0;34m'
            NC='\033[0m'
            
            echo -e "\${BLUE}Starting deployment for ${CLIENTE_LOWER}...\${NC}"
            
            # Preparar directorio
            echo -e "\${BLUE}Preparing deployment directory...\${NC}"
            sudo mkdir -p ${DEPLOY_DIR}
            sudo mkdir -p ${BACKUP_DIR}
            cd ${DEPLOY_DIR}
            
            # Copiar nuevo .env primero (antes del backup)
            sudo cp /tmp/kaptia.env ${DEPLOY_DIR}/.env
            sudo chmod 600 ${DEPLOY_DIR}/.env
            
            # Crear backup si existe instalaci√≥n previa
            if [ -f "${DEPLOY_DIR}/docker-compose.yml" ]; then
              echo -e "\${BLUE}Creating backup...\${NC}"
              BACKUP_FILE="${BACKUP_DIR}/backup_\$(date +%Y%m%d_%H%M%S).tar.gz"
              
              # Detener contenedores (manteniendo vol√∫menes)
              sudo docker compose down
              
              # Backup de archivos (excluyendo .env nuevo)
              sudo tar -czf "\$BACKUP_FILE" \
                --exclude='*.log' \
                --exclude='node_modules' \
                --exclude='.env' \
                .
              echo -e "\${GREEN}‚úì Backup created: \$BACKUP_FILE\${NC}"
            fi
            
            # Extraer aplicaci√≥n
            echo -e "\${BLUE}Extracting application files...\${NC}"
            sudo tar -xzf /tmp/kaptia-app.tar.gz -C ${DEPLOY_DIR}
            
            # Crear directorios con permisos correctos (para n8n y waha)
            echo -e "\${BLUE}Creating data directories with correct permissions...\${NC}"
            sudo mkdir -p ${DEPLOY_DIR}/n8n_data ${DEPLOY_DIR}/waha_data
            sudo chown -R 1000:1000 ${DEPLOY_DIR}/n8n_data ${DEPLOY_DIR}/waha_data
            sudo chmod -R 755 ${DEPLOY_DIR}/n8n_data ${DEPLOY_DIR}/waha_data
            
            # Pull im√°genes
            echo -e "\${BLUE}Pulling Docker images...\${NC}"
            sudo docker compose pull
            
            # Desplegar
            echo -e "\${BLUE}Deploying application...\${NC}"
            sudo docker compose up -d --remove-orphans
            
            # Verificar estado
            echo -e "\${BLUE}Checking container status...\${NC}"
            sleep 10
            sudo docker compose ps
            
            # Limpiar
            rm -f /tmp/kaptia-app.tar.gz
            
            echo -e "\${GREEN}‚úì Deployment completed successfully for ${CLIENTE_LOWER}!\${NC}"
          EOF
      
      - name: üè• Health check
        run: |
          SSH_USER="${{ secrets[format('{0}_SSH_USER', github.event.inputs.cliente)] }}"
          SERVER_HOST="${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}"
          
          ssh ${SSH_USER}@${SERVER_HOST} << 'EOF'
            cd ${{ env.DEPLOY_DIR }}
            
            # Verificar contenedores en ejecuci√≥n
            RUNNING=$(sudo docker compose ps --filter "status=running" --format json | jq -s 'length')
            TOTAL=$(sudo docker compose ps --format json | jq -s 'length')
            
            echo "Containers running: $RUNNING/$TOTAL"
            
            if [ "$RUNNING" -eq "$TOTAL" ]; then
              echo "‚úì All containers are healthy"
              exit 0
            else
              echo "‚ö† Some containers are not running"
              sudo docker compose ps
              exit 1
            fi
          EOF
      
      - name: üìä Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Cliente:** ${{ github.event.inputs.cliente }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets[format('{0}_SERVER_HOST', github.event.inputs.cliente)] }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
      
      - name: üí¨ Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs for more details."
